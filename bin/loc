#!/usr/bin/python3
import requests
from lxml import html, etree

debug = False
iconUrl = "/assets/221216_101944/images/bg/icons/sprites/desktop/personals/sprite.svg"
maxDistance = 15

badBreadcrumbs = ['Men Looking for', 'Men Seeking', 'M4w', 'Erotic Photographers', 'Phone & Cam',
    'Transgender', 'Transsexuals', 'T4m', 'M4m', 'Jobs', 'Crossdresser', 'Shopping']
 

#response = requests.get("https://sydney.locanto.com.au/Personals/P/?sort=date")

for pagination in [0, 1, 2]:

    url = "https://www.locanto.com.au/geo/498622/Personals/P/Ryde-Sydney/?dist={}&sort=date".format(maxDistance)
    if pagination > 0:
        url = "{}&page={}".format(url, pagination)

    if debug:
        print(url)

    page = html.fromstring(requests.get(url).text)

    for ad in page.xpath('//div[contains(@class, "bp_ad ") and not(contains(@class, "--native_ad"))]'):
        good = 'âœ“'
        vip = ad.xpath('.//div[contains(@class, "resultImage--P")]')
        if len(vip) > 0:
            good = 'âœ˜'
        m4m = ad.xpath('.//use[@*[local-name()="xlink:href"]="{}#204"]'.format(iconUrl))
        w4mOrm4w = ad.xpath('.//use[@*[local-name()="xlink:href"]="{}#201_202"]'.format(iconUrl))
        w4w = ad.xpath('.//use[@*[local-name()="xlink:href"]="{}#203"]'.format(iconUrl))
        fetishOrTrans = ad.xpath('.//use[@*[local-name()="xlink:href"]="{}#207"]'.format(iconUrl))
        otherServicesOrPhotographyOrJobsOrPhoneCam = ad.xpath('.//use[@*[local-name()="xlink:href"]="{}#209"]'.format(iconUrl))
        if len(m4m) > 0 or len(w4w) > 0:
            good = 'âœ˜'
        ad_url = ad.xpath('.//a[@class="bp_ad__link"]/@href')[0]
        if debug:
            print(' ', good, ad_url)
        if good == 'âœ“':
            page = html.fromstring(requests.get(ad_url).text)
            breadcrumb = page.xpath('//div[@class="breadcrumb_item"][last()]/a/text()')[0].strip()
            for badBreadcrumb in badBreadcrumbs:
                if badBreadcrumb in breadcrumb:
                    good = 'âœ˜'
                    break
            if debug:
                print('  ', good, breadcrumb)
            if good == 'âœ˜':
                continue
            posted = ''.join(page.xpath('//div[@class="posting_info"]//text()')).replace('\n', ' ').strip().replace('Posted ', '')
            location = page.xpath('//span[@itemprop="addressLocality"]/text()')[0].strip()
            phonedata = page.xpath('//a[@data-phone]')
            phonedata = 'ðŸ“ž ' if len(phonedata) > 0 else ''
            print('  {}{},'.format(phonedata, location), '{} [{}]'.format(breadcrumb, posted))
            print('    ', ad_url)
        #desc = ad.xpath('.//a[@class="bp_ad__desc_link"]')[0]
        #print(etree.tostring(ad))
        #print(category)
        #print()
        #print(title.text)
        #print()
        #print(desc.text)
        #print()
